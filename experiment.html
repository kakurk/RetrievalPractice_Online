<!DOCTYPE html>
<html>
    <head>
        <title>My experiment</title>
        <script src="jspsych-6.3.0/jspsych.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="jspsych-6.3.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.3.0/plugins/jspsych-canvas-keyboard-response.js"></script>
        <script src="jspsych-6.3.0/plugins/jspsych-canvas-keyboard-response-mouse-click.js"></script>
        <script src="jspsych-6.3.0/plugins/jspsych-instructions.js"></script>
        <script src="jspsych-6.3.0/plugins/jspsych-fullscreen.js"></script>
        <script src="jspsych-6.3.0/plugins/jspsych-preload.js"></script>
        <script src="encoding.js"></script>
        <script src="functions.js"></script>
        <script src="restudy.js"></script>
        <script src="retpractice.js"></script>
        <script src="retrieval.js"></script>
        <link href="jspsych-6.3.0/css/jspsych.css" rel="stylesheet" type="text/css">
        <style>
            .parent {
              position: relative;
              width: 800px;
              height: 549px;
              margin-left: auto;
              margin-right: auto;
              background-image: url("stim/scenes/DiningRoom2.jpg");
              background-size: 100%;
              /* border: 5px blue solid; */
            }
            .imageResize{
              width: 800px;
              height: 549px;
            }
            .parent_recon {
              display: flex;
              justify-content: center;
              align-items: center;
              width: 800px;
              height: 549px;
              margin-left: auto;
              margin-right: auto;
              background-image: url("stim/scenes/DiningRoom2.jpg");
              background-size: 100%;
            }
            .foreground {
              position: absolute;
              top: 150px;
              left: 150px;
              width: 150px;
              height: 150px;
              /* border: 5px red solid; */
            }
            .foreground_recon {
              width: 150px;
              height: 150px;
              /* border: 5px red solid; */
            }
            .resp1 {
              float: left;
              padding: 15px;
              width: 200px;
            }
            .resp2 {
              float: right;
              padding: 15px;
              width: 200px;
            }
            .jspsych-instructions-nav {
              clear: both
            }
            .resp_opt_div {
              width: 800px;
              margin-left: auto;
              margin-right: auto;
            }
            .HeaderText {
              width: 800px;
              padding: 15px;
              margin-left: auto;
              margin-right: auto;
            }
          </style>
    </head>
    <body></body>
    <script>

    // ask user if they are sure they want to leave early
    $(window).on('beforeunload', function() {
        return "Are you sure you do not want to continue with the experiment?";
    });

    // grabs all variables from the url
    // url variables are specified as follows:
    // Ex: experiment.html?subject=s001
    // urlvar.subject = 's001'
    var urlvar = jsPsych.data.urlVariables();
    console.log(urlvar.subject)
    jsPsych.data.addProperties({subject: urlvar.subject});

    // experiment wide parameters
    var canvasW = 1200 // width of the drawing area (px)
    var canvasH = 600 // height of the drawing area (px)
    var objectH = 150 // height of the object (px)
    var objectW = 150 // width of the object (px)
    var sceneW = 1000 // width of the scene (px)
    var sceneH = sceneW*(412/600) // height of the scene (px)
    // Reconstruction
    var guide_cir_r = 250; // radius of guide circle, (px)
    var innerR = guide_cir_r - 25; // inner click area radius, (px)
    var outerR = guide_cir_r + 25; // outer click area radius, (px)
    // 6 AFC
    var AFC_H = 125 // height of the alternatives (px)
    var AFC_W = AFC_H * 600/412 // width of the alternatives (px)
    var firstRow = 250 // position of the first row (px)
    var secondRow = 425 // position of the second row (px)
    var firstColumn = 300 // position of the first column (px)
    var secondColumn = canvasW/2 - AFC_W/2 // position of the second column (px)
    var thirdColumn = secondColumn + (secondColumn - firstColumn) // position of the third column (px)

    // experiment wide
    var iti = {
        type: 'html-keyboard-response',
        stimulus: '<p style="font-size: 48px;">+</p>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 1000,
        data: { experimentComponent: 'ITI'},
        save_trial_parameters: {
            stimulus: false,
            choices: false
        }};

    // fullscreen on; fullescreen off
    var fullscreenOn = {
      type: 'fullscreen',
      data: { experimentComponent: 'fullscreenUp'},
      fullscreen_mode: true
    }

    var fullscreenOff = {
      type: 'fullscreen',
      data: { experimentComponent: 'fullscreenDown'},
      fullscreen_mode: false
    }

    // preload stimuli
    var scenes_to_preload
    var objects_to_preload
    scenes_to_preload = enc_data.map(enc_data => enc_data.Scene);
    scenes_to_preload = scenes_to_preload.concat(retrieval_data.map(retrieval_data => retrieval_data.RespOption1))
    scenes_to_preload = scenes_to_preload.concat(retrieval_data.map(retrieval_data => retrieval_data.RespOption2))
    scenes_to_preload = scenes_to_preload.concat(retrieval_data.map(retrieval_data => retrieval_data.RespOption3))
    scenes_to_preload = scenes_to_preload.concat(retrieval_data.map(retrieval_data => retrieval_data.RespOption4))
    scenes_to_preload = scenes_to_preload.concat(retrieval_data.map(retrieval_data => retrieval_data.RespOption5))
    scenes_to_preload = scenes_to_preload.concat(retrieval_data.map(retrieval_data => retrieval_data.RespOption6))
    objects_to_preload = enc_data.map(enc_data => enc_data.Object);

    var preload = {
     type: 'preload',
     data: { experimentComponent: 'preload'},
     images: scenes_to_preload.concat(objects_to_preload),
     save_trial_parameters: {
         failed_audio: false,
         failed_video: false,
         timeout: false
     }
    }

    var stimulus_example = "<div class='parent'><img class='foreground' src='stim/objects/Volleyball_2_br.png' /></div>"
    // var recon_example =  "<div class='parent_recon'><img class='foreground_recon' src='stim/objects/Volleyball_2_br.png' /></div>"
    var response_option_div = "<div class='resp_opt_div'><div class='resp1'>1- Likely</div><div class='resp2'>2- Unlikely</div></div>"
    var recon_example = '<img class="imageResize" src="ReconstructionExample_nocross.png"></img>'
    var recon_example_cross = '<img class="imageResize" src="ReconstructionExample_withcross.PNG"></img>' //
    var gist_test_example = '<img class="imageResize" src="Retrieval_GistTestExample.png"></img>'

    var enc_instruction = {
      type: 'instructions',
      pages: ['<div class="HeaderText"><p>Welcome to the experiment.</p><p>Click next to advance.</p></div>',
              '<div class="HeaderText">In the following encoding phase of the experiment, you will be presented with an object placed on top of a background scene:</div>'+stimulus_example,
              '<div class="HeaderText">'+'You will be asked on each trial to determine how likely the object is to be found in its specific position withn the scene.'+
              ' Press the <b>1 key at the top of the keyboard</b> if you think the object is <i>likely</i> to be found in its specific position within the scene. '+
              'Press the <b>2 key at the top of the keyboard</b> if you think the object is <i>unlikey</i> to be found in its specific position within the scene.'+
              '</div>'+stimulus_example+response_option_div,
              '<div class="HeaderText"><p>You will be presented with 40 object-image pairs.</p><p>The encoding phase will take approximately 8 minutes to complete</p><p>Click next to begin.</p></div>'],
      show_clickable_nav: true
    };

    var encoding_stimulus = {
     type: 'canvas-keyboard-response',
     stimulus: function(c) {
       // c.style.border = "5px solid #A9A9A9";
       // present images on a canvas at specific locations
       var ctx = c.getContext('2d');
       var object = new Image();
       var scene = new Image();
       object.src = jsPsych.timelineVariable('Object');
       scene.src = jsPsych.timelineVariable('Scene');
       var centerx = canvasW/2 - sceneW/2;
       var centery = canvasH/2 - sceneH/2;
       ctx.drawImage(scene, centerx, centery, sceneW, sceneH);
       var centerx = canvasW/2 - objectW/2;
       var centery = canvasH/2 - objectH/2;
       var xPos = jsPsych.timelineVariable('xPos');
       var yPos = jsPsych.timelineVariable('yPos');
       ctx.drawImage(object, centerx+xPos, centery+yPos, objectW, objectH);
     },
     canvas_size: [canvasH, canvasW],
     choices: ['1','2'],
     trial_duration: 4000,
     response_ends_trial: false
    };

    var encoding_trials = {
      timeline: [iti, encoding_stimulus],
      timeline_variables: enc_data
    }

    var encoding = {timeline: [enc_instruction, encoding_trials, iti], data: { experimentComponent: 'encoding'}}

    // practice phase
    var retpractice_instructions = {
      type: 'instructions',
      pages: ['<div class="HeaderText"><p>You completed the encoding phase.</p><p>You will now complete the practice phase.</p><p>Click next to advance.</p></div>',
              '<div class="HeaderText"><p>In the following practice phase of the experiment, you will be represented with the objects and scenes from the encoding phase.</p><p>You will be asked on each trial to EITHER restudy the object and scene pair OR to report the position that the object was shown on the scene.</p></div>',
              '<div class="HeaderText">On study trials, you will simply be represented with the original object scene pairing. Your task it to commit the object-scene pair to memory. No response is required.</div>'+stimulus_example,
              '<div class="HeaderText">On practice trials, you will be presented with an object/scene pair with the object presented in the center of the screen. You are tasked with indicating the position that the object was on the scene using your mouse.</div>'+recon_example,
              '<div class="HeaderText">Click on the position you remember seeing the object on the screen by clicking in a position nearby the back dashed circle. When a response is recorded, a white X will appear at your responded location.</div>'+recon_example_cross,
              '<div class="HeaderText"><p>You will complete 3 rounds of restudy and retrieval.</p><p>In total, this practice phase will take approximately 16 minutes to complete.</p><p>Click next to begin.</p></div>'],
      show_clickable_nav: true
    };

   // Restudy

   var restudy_instructions = {
     type: 'html-keyboard-response',
     stimulus: '<p style="font-size: 48px;">RESTUDY</p>',
     choices: jsPsych.NO_KEYS,
     trial_duration: 4000,
     save_trial_parameters: {
         stimulus: false,
         choices: false
     }
   }

   var restudy_stimulus = extend(encoding_stimulus);
   restudy_stimulus.trial_duration = 6000

   var restudy_trials = {
     timeline: [iti, restudy_stimulus],
     timeline_variables: restudy_data,
   }

   var restudy = {timeline: [restudy_instructions, restudy_trials]}

   // Practice

   var practice_instructions = {
     type: 'html-keyboard-response',
     stimulus: '<p style="font-size: 48px;">RETRIEVAL</p>',
     choices: jsPsych.NO_KEYS,
     trial_duration: 4000,
     save_trial_parameters: {
         stimulus: false,
         choices: false
     }
   }

   var recontruct_trial = {
     type: 'canvas-keyboard-response-mouse-click',
     images: [jsPsych.timelineVariable('Object'), jsPsych.timelineVariable('Scene')],
     stimulus: function(c, object, scene) {
       // canvas
       var ctx = c.getContext('2d');
       // draw scene
       var centerx = canvasW/2 - sceneW/2;
       var centery = canvasH/2 - sceneH/2;
       ctx.drawImage(scene, centerx, centery, sceneW, sceneH);
       // draw object
       var centerx = canvasW/2 - objectW/2;
       var centery = canvasH/2 - objectH/2;
       ctx.drawImage(object, centerx, centery, objectW, objectH);
       // draw guide circle
       ctx.strokeStyle = 'black'
       ctx.setLineDash([15, 15]);
       ctx.arc(canvasW/2, canvasH/2, guide_cir_r, 0, 2 * Math.PI);
       ctx.lineWidth = 5;
       ctx.stroke();
     },
     canvas_size: [canvasH, canvasW],
     click_area: [innerR, outerR],
     choices: ['1','2'],
     response_ends_trial: false,
     trial_duration: 6000
   };

   var feedback = extend(encoding_stimulus);
   feedback.trial_duration = 1000;
   feedback.stimulus = function(c){
     // present images on a canvas at specific locations
     var ctx = c.getContext('2d');
     // draw scene
     var scene = new Image();
     scene.src = jsPsych.timelineVariable('Scene');
     var centerx = canvasW/2 - sceneW/2;
     var centery = canvasH/2 - sceneH/2;
     ctx.drawImage(scene, centerx, centery, sceneW, sceneH);
     // draw guide circle
     ctx.strokeStyle = 'black'
     ctx.setLineDash([15, 15]);
     ctx.arc(canvasW/2, canvasH/2, guide_cir_r, 0, 2 * Math.PI);
     ctx.lineWidth = 5;
     ctx.stroke();
     // draw object jsPsych.timelineVariable('obj_width')*.75, jsPsych.timelineVariable('obj_width')*jsPsych.timelineVariable('obj_ratio')*.75
     var object = new Image(50,50);
     object.src = jsPsych.timelineVariable('Object');
     var centerx = canvasW/2 - objectW/2;
     var centery = canvasH/2 - objectH/2;
     var xPos = jsPsych.timelineVariable('xPos');
     var yPos = jsPsych.timelineVariable('yPos');
     ctx.drawImage(object, centerx+xPos, centery+yPos, objectW, objectH);
   }

   var practice_trials = {
     timeline: [iti, recontruct_trial, feedback],
     timeline_variables: retpractice_data
   }

   var practice = {timeline: [practice_instructions, practice_trials]}

   var restudy_practice = {timeline: [restudy, practice], repetitions: 3}

   var restudy_practice_all = {timeline: [retpractice_instructions, restudy_practice],  data: { experimentComponent: 'practice'}}

   // retrieval
   var retreival_instructions = {
     type: 'instructions',
     pages: ['<div class="HeaderText"><p>You completed the practice phase.</p><p>You will now complete the retrieval phase.</p><p>Click next to advance.</p></div>',
             '<div class="HeaderText"><p>In the following retrieval phase of the experiment, you will be represented with the object/scene pairs from the encoding phase.</p><p>On each trial, you will be asked to identify which scene went with each object using a multiple choice test. Immediately afterwards, you will be asked to indicate where the object was placed on top of its scene.</p></div>',
             '<div class="HeaderText">For the scene memory test, you will be represented with an object from the encoding phase along with 6 scene options. Use the 1 through 6 keys at the top of the keyboard to indicate which scene was paired with the object.</div>'+gist_test_example,
             '<div class="HeaderText">For the location memory test, you will be presented with an object/scene pair with the object presented in the center of the screen. You are tasked with indicating the position that the object was on the scene using your mouse.</div>'+recon_example,
             '<div class="HeaderText">Click on the position you remember seeing the object on the screen by clicking in a position nearby the back dashed circle. When a response is recorded, a white X will appear at your responded location.</div>'+recon_example_cross,
             '<div class="HeaderText"><p>In total, this retreival phase will take approximately 6 minutes to complete.</p><p>Click next when you are ready to begin.</p></div>'],
     show_clickable_nav: true
   };

   var retrieval_gist_test = {
     type: 'canvas-keyboard-response',
     stimulus: function(c) {
       // c.style.border = "5px solid #A9A9A9";
       // present images on a canvas at specific locations
       var ctx = c.getContext('2d');
       var probe = new Image();
       var AFC1 = new Image();
       var AFC2 = new Image();
       var AFC3 = new Image();
       var AFC4 = new Image();
       var AFC5 = new Image();
       var AFC6 = new Image();
       probe.src = jsPsych.timelineVariable('Object');
       AFC1.src = jsPsych.timelineVariable('RespOption1');
       AFC2.src = jsPsych.timelineVariable('RespOption2');
       AFC3.src = jsPsych.timelineVariable('RespOption3');
       AFC4.src = jsPsych.timelineVariable('RespOption4');
       AFC5.src = jsPsych.timelineVariable('RespOption5');
       AFC6.src = jsPsych.timelineVariable('RespOption6');
       var centerx = canvasW/2 - objectW/2
       var centery = canvasH/2 - objectH/2
       ctx.drawImage(probe, centerx, centery-200, objectW, objectH);

       ctx.drawImage(AFC1, firstColumn, firstRow, AFC_W, AFC_H);
       ctx.font = '20px Arial';
       ctx.fillText('1', firstColumn+(AFC_W/2), firstRow+AFC_H+25)

       ctx.drawImage(AFC2, secondColumn, firstRow, AFC_W, AFC_H);
       ctx.fillText('2', secondColumn+(AFC_W/2), firstRow+AFC_H+25)

       ctx.drawImage(AFC3, thirdColumn, firstRow, AFC_W, AFC_H);
       ctx.fillText('3', thirdColumn+(AFC_W/2), firstRow+AFC_H+25)

       ctx.drawImage(AFC4, firstColumn, secondRow, AFC_W, AFC_H);
       ctx.fillText('4', firstColumn+(AFC_W/2), secondRow+AFC_H+25)

       ctx.drawImage(AFC5, secondColumn, secondRow, AFC_W, AFC_H);
       ctx.fillText('5', secondColumn+(AFC_W/2), secondRow+AFC_H+25)

       ctx.drawImage(AFC6, thirdColumn, secondRow, AFC_W, AFC_H);
       ctx.fillText('6', thirdColumn+(AFC_W/2), secondRow+AFC_H+25)
     },
     canvas_size: [canvasH, canvasW],
     prompt: null,
     choices: ['1','2','3','4','5','6'],
     response_ends_trial: false,
     trial_duration: 6000
   };

   var retreival_verbaitum_test = extend(recontruct_trial)

   var retrieval_procedure = {
     timeline: [iti, retrieval_gist_test, iti, retreival_verbaitum_test],
     timeline_variables: retrieval_data
   }

   var retrieval = {timeline: [retreival_instructions, retrieval_procedure], data: { experimentComponent: 'retrieval'}}

   // initialize jsPsych
    jsPsych.init({
        timeline: [preload, fullscreenOn, restudy_practice_all, retrieval, fullscreenOff], // encoding, retrieval
        on_finish: function(data){

          // a unique data/time string
          // mm-dd-yyyy-hh-mm-ss
          var today = new Date();
          var datestring = today.getMonth() + '-' + today.getDate() + '-' + today.getFullYear() + '-' + today.getHours() + '-' + today.getMinutes() + '-' + today.getSeconds()

          // Save Data w/ unique data/time string
          saveData(datestring + '_' + urlvar.subject + "_experiment_data", jsPsych.data.get().csv());
          saveData(datestring + '_' + urlvar.subject + "_interaction_data", jsPsych.data.getInteractionData().csv());

          // Display the link so participants can give themselves SONA credit
          var el = jsPsych.getDisplayElement();
          var a = document.createElement('a');
          var farewell_paragraph = document.createElement('p');
          var farewell_text = document.createTextNode("Thank you for participating!");
          farewell_paragraph.appendChild(farewell_text);
          var linkText = document.createTextNode("Follow This Link To Get SONA Credit");
          a.appendChild(linkText);
          a.href = "http://capricorn.bc.edu/memolab/" //"https://bc.sona-systems.com/webstudy_credit.aspx?experiment_id=1127&credit_token=2d1623ee4a54413d826ed9a1b282539d&survey_code=" + urlvar.subject;
          el.appendChild(farewell_paragraph);
          el.appendChild(a);

        }
    })

  </script>

</html>
